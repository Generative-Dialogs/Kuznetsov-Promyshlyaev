<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<section xmlns="http://docbook.org/ns/docbook" version="5.0" xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="__image_manager_8py_source" xml:lang="ru">
<title>ImageManager.py</title>
<indexterm><primary>C:/Users/kir/Desktop/py/API/src/ImageManager/ImageManager.py</primary></indexterm>
<programlisting linenumbering="unnumbered"><anchor xml:id="__image_manager_8py_source_1l00001"/>00001 <emphasis role="keyword">import</emphasis>&#32;os
<anchor xml:id="__image_manager_8py_source_1l00002"/>00002 <emphasis role="keyword">import</emphasis>&#32;shutil
<anchor xml:id="__image_manager_8py_source_1l00003"/>00003 <emphasis role="keyword">from</emphasis>&#32;typing&#32;<emphasis role="keyword">import</emphasis>&#32;Optional,&#32;Any,&#32;List
<anchor xml:id="__image_manager_8py_source_1l00004"/>00004 <emphasis role="keyword">import</emphasis>&#32;logging
<anchor xml:id="__image_manager_8py_source_1l00005"/>00005 <emphasis role="keyword">from</emphasis>&#32;<link linkend="_namespacesrc_1_1_database_manager_1_1_database_manager">src.DatabaseManager.DatabaseManager</link>&#32;<emphasis role="keyword">import</emphasis>&#32;DatabaseManager
<anchor xml:id="__image_manager_8py_source_1l00006"/>00006 <emphasis role="keyword">from</emphasis>&#32;<link linkend="_namespacesrc_1_1_image_generator_1_1_image_generator_protocol">src.ImageGenerator.ImageGeneratorProtocol</link>&#32;<emphasis role="keyword">import</emphasis>&#32;ImageGeneratorProtocol
<anchor xml:id="__image_manager_8py_source_1l00007"/>00007 <emphasis role="keyword">from</emphasis>&#32;<link linkend="_namespacesrc_1_1_image_generator_1_1_image_generator_google">src.ImageGenerator.ImageGeneratorGoogle</link>&#32;<emphasis role="keyword">import</emphasis>&#32;ImageGeneratorGoogle
<anchor xml:id="__image_manager_8py_source_1l00008"/>00008 <emphasis role="keyword">from</emphasis>&#32;<link linkend="_namespacesrc_1_1_image_prompt_generator_1_1_image_prompt_generator">src.ImagePromptGenerator.ImagePromptGenerator</link>&#32;<emphasis role="keyword">import</emphasis>&#32;ImagePromptGenerator
<anchor xml:id="__image_manager_8py_source_1l00009"/>00009 <emphasis role="keyword">from</emphasis>&#32;<link linkend="_namespacesrc_1_1_game_master_1_1_game_master_promts">src.GameMaster.GameMasterPromts</link>&#32;<emphasis role="keyword">import</emphasis>&#32;off_topic_message_eng,&#32;off_topic_message_ru
<anchor xml:id="__image_manager_8py_source_1l00010"/>00010 <emphasis role="keyword">from</emphasis>&#32;<link linkend="_namespacesrc_1_1config">src.config</link>&#32;<emphasis role="keyword">import</emphasis>&#32;IMAGE_OUTPUT_DIR
<anchor xml:id="__image_manager_8py_source_1l00011"/>00011 
<anchor xml:id="__image_manager_8py_source_1l00012"/>00012 error_image_path&#32;=&#32;<emphasis role="stringliteral">&apos;src/ImageManager/error.png&apos;</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00013"/>00013 
<anchor xml:id="__image_manager_8py_source_1l00014"/><link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager">00014</link> <emphasis role="keyword">class&#32;</emphasis><link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager">ImageManager</link>:
<anchor xml:id="__image_manager_8py_source_1l00015"/>00015 &#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;&quot;&quot;!</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00016"/>00016 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;@brief&#32;Менеджер&#32;для&#32;управления&#32;генерацией&#32;и&#32;хранением&#32;изображений</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00017"/>00017 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00018"/>00018 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;@details</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00019"/>00019 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;Класс&#32;отвечает&#32;за:</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00020"/>00020 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;-&#32;Генерацию&#32;портретов&#32;персонажей</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00021"/>00021 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;-&#32;Создание&#32;изображений&#32;сцен</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00022"/>00022 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;-&#32;Управление&#32;файлами&#32;изображений</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00023"/>00023 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;-&#32;Взаимодействие&#32;с&#32;базой&#32;данных&#32;для&#32;хранения&#32;информации&#32;об&#32;изображениях</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00024"/>00024 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&quot;&quot;&quot;</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00025"/>00025 &#32;&#32;&#32;&#32;__session_id:&#32;int
<anchor xml:id="__image_manager_8py_source_1l00026"/>00026 &#32;&#32;&#32;&#32;__db:&#32;DatabaseManager
<anchor xml:id="__image_manager_8py_source_1l00027"/>00027 &#32;&#32;&#32;&#32;__image_generator:&#32;ImageGeneratorProtocol
<anchor xml:id="__image_manager_8py_source_1l00028"/>00028 &#32;&#32;&#32;&#32;__prompt_generator:&#32;ImagePromptGenerator
<anchor xml:id="__image_manager_8py_source_1l00029"/>00029 
<anchor xml:id="__image_manager_8py_source_1l00030"/><link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1adf109f7e341a2ada404f984e7ad2d986">00030</link> &#32;&#32;&#32;&#32;<emphasis role="keyword">def&#32;</emphasis><link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1adf109f7e341a2ada404f984e7ad2d986">__init__</link>(self,&#32;session_id:&#32;int)&#32;-&gt;&#32;<emphasis role="keywordtype">None</emphasis>:
<anchor xml:id="__image_manager_8py_source_1l00031"/>00031 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;&quot;&quot;!</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00032"/>00032 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;@brief&#32;Инициализация&#32;менеджера&#32;изображений</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00033"/>00033 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00034"/>00034 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;@param&#32;session_id&#32;ID&#32;сессии&#32;для&#32;организации&#32;файлов&#32;изображений</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00035"/>00035 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&quot;&quot;</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00036"/>00036 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1a3465ec8f770e1d18ac5dd5b9b8fbc456">__session_id</link>&#32;=&#32;session_id
<anchor xml:id="__image_manager_8py_source_1l00037"/>00037 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1ae9ba57ed0c65ba1f56460d0cc94affff">__db</link>&#32;=&#32;<link linkend="_classsrc_1_1_database_manager_1_1_database_manager_1_1_database_manager">DatabaseManager</link>()
<anchor xml:id="__image_manager_8py_source_1l00038"/>00038 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1ae507231a3f50da5695b2a08c271c5f6e">__image_generator</link>&#32;=&#32;<link linkend="_classsrc_1_1_image_generator_1_1_image_generator_google_1_1_image_generator_google">ImageGeneratorGoogle</link>(session_id)
<anchor xml:id="__image_manager_8py_source_1l00039"/>00039 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1a72ef9f21452a12537f50d12508c1e900">__prompt_generator</link>&#32;=&#32;<link linkend="_classsrc_1_1_image_prompt_generator_1_1_image_prompt_generator_1_1_image_prompt_generator">ImagePromptGenerator</link>(session_id)
<anchor xml:id="__image_manager_8py_source_1l00040"/>00040 
<anchor xml:id="__image_manager_8py_source_1l00041"/><link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1a3d93b2b2a90ff5fecaab453bbd9f2b22">00041</link> &#32;&#32;&#32;&#32;<emphasis role="keyword">def&#32;</emphasis><link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1a3d93b2b2a90ff5fecaab453bbd9f2b22">generate_character_portrait</link>(self,&#32;character_name:&#32;str,&#32;character_description:&#32;str)&#32;-&gt;&#32;Optional[str]:
<anchor xml:id="__image_manager_8py_source_1l00042"/>00042 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;&quot;&quot;!</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00043"/>00043 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;@brief&#32;Генерация&#32;портрета&#32;персонажа</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00044"/>00044 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00045"/>00045 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;@param&#32;character_name&#32;Имя&#32;персонажа</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00046"/>00046 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;@param&#32;character_description&#32;Описание&#32;персонажа</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00047"/>00047 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00048"/>00048 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;@return&#32;Optional[str]&#32;Путь&#32;к&#32;сохраненному&#32;портрету&#32;или&#32;None&#32;в&#32;случае&#32;ошибки</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00049"/>00049 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&quot;&quot;</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00050"/>00050 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">try</emphasis>:
<anchor xml:id="__image_manager_8py_source_1l00051"/>00051 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">#&#32;Create&#32;character&#32;directory&#32;if&#32;it&#32;doesn&apos;t&#32;exist</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00052"/>00052 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;character_dir&#32;=&#32;os.path.join(IMAGE_OUTPUT_DIR,&#32;str(self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1a3465ec8f770e1d18ac5dd5b9b8fbc456">__session_id</link>),&#32;<emphasis role="stringliteral">&quot;characters&quot;</emphasis>)
<anchor xml:id="__image_manager_8py_source_1l00053"/>00053 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;os.makedirs(character_dir,&#32;exist_ok=<emphasis role="keyword">True</emphasis>)
<anchor xml:id="__image_manager_8py_source_1l00054"/>00054 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;
<anchor xml:id="__image_manager_8py_source_1l00055"/>00055 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">#&#32;Create&#32;prompt&#32;for&#32;character&#32;portrait</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00056"/>00056 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;prompt&#32;=&#32;f<emphasis role="stringliteral">&quot;Create&#32;a&#32;portrait&#32;of&#32;{character_name}.&#32;{character_description}.&#32;The&#32;character&#32;should&#32;be&#32;centered&#32;on&#32;a&#32;neutral&#32;background.&#32;The&#32;style&#32;is&#32;Gloomy&#32;classical&#32;painting&#32;style&#32;with&#32;dramatic&#32;chiaroscuro,&#32;muted&#32;dark&#32;tones&#32;(charcoal&#32;black,&#32;deep&#32;navy,&#32;antique&#32;gold),&#32;Baroque/Romantic-era&#32;aesthetics,&#32;weathered&#32;oil&#32;texture,&#32;cracked&#32;varnish&#32;aging,&#32;somber&#32;atmospheric&#32;lighting,&#32;Goya-esque&#32;melancholy,&#32;Caravaggio-inspired&#32;contrasts,&#32;Turner-like&#32;stormy&#32;ambiance,&#32;haunting&#32;ethereal&#32;undertones,&#32;detailed&#32;brushwork&#32;on&#32;textures&#32;(stone,&#32;fabric),&#32;cold&#32;palette&#32;with&#32;crimson&#32;accents,&#32;gothic&#32;decay&#32;motifs,&#32;and&#32;misty&#32;spectral&#32;ambiance.&quot;</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00057"/>00057 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;
<anchor xml:id="__image_manager_8py_source_1l00058"/>00058 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">#&#32;Generate&#32;image</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00059"/>00059 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;image_path&#32;=&#32;os.path.join(character_dir,&#32;f<emphasis role="stringliteral">&quot;{character_name}.png&quot;</emphasis>)
<anchor xml:id="__image_manager_8py_source_1l00060"/>00060 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1ae507231a3f50da5695b2a08c271c5f6e">__image_generator</link>.generate_image_response(prompt,&#32;image_path)
<anchor xml:id="__image_manager_8py_source_1l00061"/>00061 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;
<anchor xml:id="__image_manager_8py_source_1l00062"/>00062 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">except</emphasis>&#32;Exception&#32;<emphasis role="keyword">as</emphasis>&#32;e:
<anchor xml:id="__image_manager_8py_source_1l00063"/>00063 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;logging.error(f<emphasis role="stringliteral">&quot;Error&#32;generating&#32;character&#32;portrait:&#32;{str(e)}&quot;</emphasis>)
<anchor xml:id="__image_manager_8py_source_1l00064"/>00064 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;<emphasis role="keywordtype">None</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00065"/>00065 
<anchor xml:id="__image_manager_8py_source_1l00066"/><link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1ac9ee1fea0ddc63d7373be64fc1924487">00066</link> &#32;&#32;&#32;&#32;<emphasis role="keyword">def&#32;</emphasis><link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1ac9ee1fea0ddc63d7373be64fc1924487">generate_and_save_image</link>(self,&#32;user_input:&#32;str,&#32;actor_output:&#32;str,&#32;character_ids:&#32;List[int])&#32;-&gt;&#32;Optional[str]:
<anchor xml:id="__image_manager_8py_source_1l00067"/>00067 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;&quot;&quot;!</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00068"/>00068 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;@brief&#32;Генерация&#32;и&#32;сохранение&#32;изображения&#32;сцены</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00069"/>00069 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00070"/>00070 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;@param&#32;user_input&#32;Ввод&#32;пользователя</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00071"/>00071 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;@param&#32;actor_output&#32;Описание&#32;сцены&#32;от&#32;актора</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00072"/>00072 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;@param&#32;character_ids&#32;Список&#32;ID&#32;персонажей,&#32;участвующих&#32;в&#32;сцене</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00073"/>00073 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00074"/>00074 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;@return&#32;Optional[str]&#32;Путь&#32;к&#32;сохраненному&#32;изображению&#32;или&#32;None&#32;в&#32;случае&#32;ошибки</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00075"/>00075 <emphasis role="stringliteral">&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&quot;&quot;&quot;</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00076"/>00076 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;actor_output&#32;<emphasis role="keywordflow">in</emphasis>&#32;[off_topic_message_ru,&#32;off_topic_message_eng]:
<anchor xml:id="__image_manager_8py_source_1l00077"/>00077 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1ae9ba57ed0c65ba1f56460d0cc94affff">__db</link>.save_image_prompt(self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1a3465ec8f770e1d18ac5dd5b9b8fbc456">__session_id</link>,&#32;user_input,&#32;actor_output,&#32;off_topic_message_eng)
<anchor xml:id="__image_manager_8py_source_1l00078"/>00078 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;image_prompts&#32;=&#32;self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1ae9ba57ed0c65ba1f56460d0cc94affff">__db</link>.get_image_prompts(self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1a3465ec8f770e1d18ac5dd5b9b8fbc456">__session_id</link>)
<anchor xml:id="__image_manager_8py_source_1l00079"/>00079 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;next_sequence&#32;=&#32;len(image_prompts)&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;
<anchor xml:id="__image_manager_8py_source_1l00080"/>00080 
<anchor xml:id="__image_manager_8py_source_1l00081"/>00081 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;target_path&#32;=&#32;f<emphasis role="stringliteral">&quot;{IMAGE_OUTPUT_DIR}/{self.__session_id}/{next_sequence}.png&quot;</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00082"/>00082 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;shutil.copy2(error_image_path,&#32;target_path)
<anchor xml:id="__image_manager_8py_source_1l00083"/>00083 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;
<anchor xml:id="__image_manager_8py_source_1l00084"/>00084 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;target_path
<anchor xml:id="__image_manager_8py_source_1l00085"/>00085 
<anchor xml:id="__image_manager_8py_source_1l00086"/>00086 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">#&#32;Generate&#32;prompt&#32;with&#32;character&#32;information</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00087"/>00087 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;image_prompt&#32;=&#32;self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1a72ef9f21452a12537f50d12508c1e900">__prompt_generator</link>.generate_prompt(user_input,&#32;actor_output,&#32;character_ids)
<anchor xml:id="__image_manager_8py_source_1l00088"/>00088 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;
<anchor xml:id="__image_manager_8py_source_1l00089"/>00089 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">#&#32;Get&#32;the&#32;next&#32;sequence&#32;number&#32;from&#32;database</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00090"/>00090 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;image_prompts&#32;=&#32;self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1ae9ba57ed0c65ba1f56460d0cc94affff">__db</link>.get_image_prompts(self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1a3465ec8f770e1d18ac5dd5b9b8fbc456">__session_id</link>)
<anchor xml:id="__image_manager_8py_source_1l00091"/>00091 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;next_sequence&#32;=&#32;len(image_prompts)
<anchor xml:id="__image_manager_8py_source_1l00092"/>00092 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;
<anchor xml:id="__image_manager_8py_source_1l00093"/>00093 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">#&#32;Get&#32;character&#32;image&#32;paths</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00094"/>00094 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;character_images&#32;=&#32;[]
<anchor xml:id="__image_manager_8py_source_1l00095"/>00095 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;char_id&#32;<emphasis role="keywordflow">in</emphasis>&#32;character_ids:
<anchor xml:id="__image_manager_8py_source_1l00096"/>00096 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;character&#32;=&#32;self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1ae9ba57ed0c65ba1f56460d0cc94affff">__db</link>.get_character(char_id)
<anchor xml:id="__image_manager_8py_source_1l00097"/>00097 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;character:
<anchor xml:id="__image_manager_8py_source_1l00098"/>00098 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;name,&#32;_&#32;=&#32;character
<anchor xml:id="__image_manager_8py_source_1l00099"/>00099 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;char_image_path&#32;=&#32;os.path.join(IMAGE_OUTPUT_DIR,&#32;str(self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1a3465ec8f770e1d18ac5dd5b9b8fbc456">__session_id</link>),&#32;<emphasis role="stringliteral">&quot;characters&quot;</emphasis>,&#32;f<emphasis role="stringliteral">&quot;{name}.png&quot;</emphasis>)
<anchor xml:id="__image_manager_8py_source_1l00100"/>00100 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;os.path.exists(char_image_path):
<anchor xml:id="__image_manager_8py_source_1l00101"/>00101 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;character_images.append(char_image_path)
<anchor xml:id="__image_manager_8py_source_1l00102"/>00102 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;
<anchor xml:id="__image_manager_8py_source_1l00103"/>00103 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">#&#32;Generate&#32;and&#32;save&#32;image</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00104"/>00104 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;target_path&#32;=&#32;os.path.join(IMAGE_OUTPUT_DIR,&#32;str(self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1a3465ec8f770e1d18ac5dd5b9b8fbc456">__session_id</link>),&#32;f<emphasis role="stringliteral">&quot;{next_sequence}.png&quot;</emphasis>)
<anchor xml:id="__image_manager_8py_source_1l00105"/>00105 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;image_prompt&#32;<emphasis role="keywordflow">is</emphasis>&#32;<emphasis role="keywordtype">None</emphasis>:
<anchor xml:id="__image_manager_8py_source_1l00106"/>00106 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;<emphasis role="keywordtype">None</emphasis>
<anchor xml:id="__image_manager_8py_source_1l00107"/>00107 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;self.<link linkend="_classsrc_1_1_image_manager_1_1_image_manager_1_1_image_manager_1ae507231a3f50da5695b2a08c271c5f6e">__image_generator</link>.generate_image_response(image_prompt,&#32;target_path,&#32;character_images)&#32;
</programlisting></section>
