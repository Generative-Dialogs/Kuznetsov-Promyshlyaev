\doxysection{Game\+Master.\+py}
\label{_game_master_8py_source}\index{C:/Users/kir/Desktop/py/API/src/GameMaster/GameMaster.py@{C:/Users/kir/Desktop/py/API/src/GameMaster/GameMaster.py}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{keyword}{import}\ time}
\DoxyCodeLine{00002\ \textcolor{keyword}{from}\ typing\ \textcolor{keyword}{import}\ Optional,\ Dict,\ List,\ Tuple,\ Set}
\DoxyCodeLine{00003\ \textcolor{keyword}{from}\ src.GameMaster.CommandData\ \textcolor{keyword}{import}\ CommandData,\ CommandDataEnvironmentDescription,\ CommandSelectCharacter,\ \(\backslash\)}
\DoxyCodeLine{00004\ \ \ \ \ CommandCreateCharacter,\ CommandOffTopic,\ CommandPlayerDeath}
\DoxyCodeLine{00005\ \textcolor{keyword}{from}\ src.MessageGenerator.MessageGeneratorOpenRouter\ \textcolor{keyword}{import}\ MessageGeneratorOpenRouter}
\DoxyCodeLine{00006\ \textcolor{keyword}{from}\ src.Actor.ProtocolActor\ \textcolor{keyword}{import}\ ProtocolActor}
\DoxyCodeLine{00007\ \textcolor{keyword}{from}\ src.Actor.Actor\ \textcolor{keyword}{import}\ Actor}
\DoxyCodeLine{00008\ \textcolor{keyword}{from}\ src.MessageGenerator.ProtocolMessageGenerator\ \textcolor{keyword}{import}\ ProtocolMessageGenerator}
\DoxyCodeLine{00009\ \textcolor{keyword}{from}\ src.GameMaster.GameMasterPromts\ \textcolor{keyword}{import}\ start\_message,\ world\_description\_start,\ correct\_formatting,\ \(\backslash\)}
\DoxyCodeLine{00010\ \ \ \ \ character\_name\_start}
\DoxyCodeLine{00011\ \textcolor{keyword}{from}\ src.Descriptions.CharacterDecription\ \textcolor{keyword}{import}\ base\_character\_description}
\DoxyCodeLine{00012\ \textcolor{keyword}{from}\ src.Descriptions.WorldDecription\ \textcolor{keyword}{import}\ base\_world\_description}
\DoxyCodeLine{00013\ \textcolor{keyword}{from}\ src.DatabaseManager.DatabaseManager\ \textcolor{keyword}{import}\ DatabaseManager}
\DoxyCodeLine{00014\ \textcolor{keyword}{from}\ src.ImageManager.ImageManager\ \textcolor{keyword}{import}\ ImageManager}
\DoxyCodeLine{00015\ \textcolor{keyword}{import}\ logging}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{keyword}{class\ }PlayerDeathException(Exception):}
\DoxyCodeLine{00019\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}!}}
\DoxyCodeLine{00020\ \textcolor{stringliteral}{\ \ \ \ @brief\ Исключение,\ возникающее\ при\ смерти\ игрового\ персонажа}}
\DoxyCodeLine{00021\ \textcolor{stringliteral}{\ \ \ \ }}
\DoxyCodeLine{00022\ \textcolor{stringliteral}{\ \ \ \ @details}}
\DoxyCodeLine{00023\ \textcolor{stringliteral}{\ \ \ \ Выбрасывается,\ когда\ игровой\ персонаж\ умирает,\ что\ приводит\ к\ завершению\ сессии}}
\DoxyCodeLine{00024\ \textcolor{stringliteral}{\ \ \ \ и\ блокировке\ дальнейшего\ ввода.}}
\DoxyCodeLine{00025\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{00026\ \ \ \ \ \textcolor{keywordflow}{pass}}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ }
\DoxyCodeLine{00029\ \textcolor{keyword}{class\ }GameMaster:}
\DoxyCodeLine{00030\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}!}}
\DoxyCodeLine{00031\ \textcolor{stringliteral}{\ \ \ \ @brief\ Класс,\ управляющий\ игровым\ процессом\ и\ взаимодействием\ с\ игроком}}
\DoxyCodeLine{00032\ \textcolor{stringliteral}{\ \ \ \ }}
\DoxyCodeLine{00033\ \textcolor{stringliteral}{\ \ \ \ @details}}
\DoxyCodeLine{00034\ \textcolor{stringliteral}{\ \ \ \ Отвечает\ за:}}
\DoxyCodeLine{00035\ \textcolor{stringliteral}{\ \ \ \ -\/\ Генерацию\ ответов\ на\ действия\ игрока}}
\DoxyCodeLine{00036\ \textcolor{stringliteral}{\ \ \ \ -\/\ Управление\ игровыми\ персонажами}}
\DoxyCodeLine{00037\ \textcolor{stringliteral}{\ \ \ \ -\/\ Поддержание\ целостности\ игрового\ мира}}
\DoxyCodeLine{00038\ \textcolor{stringliteral}{\ \ \ \ -\/\ Генерацию\ изображений}}
\DoxyCodeLine{00039\ \textcolor{stringliteral}{\ \ \ \ -\/\ Взаимодействие\ с\ базой\ данных}}
\DoxyCodeLine{00040\ \textcolor{stringliteral}{\ \ \ \ }}
\DoxyCodeLine{00041\ \textcolor{stringliteral}{\ \ \ \ @note\ Реализует\ паттерн\ Singleton\ для\ обеспечения\ единой\ точки\ управления\ игровым\ процессом}}
\DoxyCodeLine{00042\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{00043\ \ \ \ \ \textcolor{keyword}{def\ }\_\_init\_\_(self,\ session\_id:\ int,\ world\_description:\ Optional[str]\ =\ \textcolor{keywordtype}{None},}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ player\_description:\ Optional[str]\ =\ \textcolor{keywordtype}{None},}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ fast\_flg:\ bool\ =\ \textcolor{keyword}{True},\ language:\ str\ =\ \textcolor{stringliteral}{"{}English"{}},}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ generate\_character\_images:\ bool\ =\ \textcolor{keyword}{True})\ -\/>\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}!}}
\DoxyCodeLine{00048\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @brief\ Инициализация\ мастера\ игры}}
\DoxyCodeLine{00049\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{00050\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @param\ session\_id\ ID\ игровой\ сессии}}
\DoxyCodeLine{00051\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @param\ world\_description\ Описание\ игрового\ мира\ (опционально)}}
\DoxyCodeLine{00052\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @param\ player\_description\ Описание\ игрового\ персонажа\ (опционально)}}
\DoxyCodeLine{00053\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @param\ fast\_flg\ Флаг\ быстрого\ режима\ (опционально)}}
\DoxyCodeLine{00054\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @param\ language\ Язык\ игры\ (опционально)}}
\DoxyCodeLine{00055\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @param\ generate\_character\_images\ Флаг\ генерации\ изображений\ персонажей\ (опционально)}}
\DoxyCodeLine{00056\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ self.session\_id\ =\ session\_id}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ self.db\ =\ DatabaseManager()}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ self.generate\_character\_images\ =\ generate\_character\_images}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ world\_description\ \textcolor{keywordflow}{is}\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \ \ \ \ world\_description\ =\ base\_world\_description}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ player\_description\ \textcolor{keywordflow}{is}\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ \ \ \ \ player\_description\ =\ base\_character\_description}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ self.world\_description\ =\ world\_description}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ self.player\_description\ =\ player\_description}
\DoxyCodeLine{00068\ }
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ self.messageGenerator:\ ProtocolMessageGenerator\ =\ MessageGeneratorOpenRouter()}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ self.characters:\ Dict[str,\ str]\ =\ \{\}\ \ \textcolor{comment}{\#\ name\ -\/>\ description}}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ self.\_\_actor\ =\ Actor(self,\ session\_id,\ \ fast\_flg=fast\_flg,\ language=language)}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ self.\_\_image\_manager\ =\ ImageManager(session\_id)}
\DoxyCodeLine{00073\ }
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ logging.basicConfig(filename=\textcolor{stringliteral}{'game\_master.log'},\ level=logging.INFO,}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ format=\textcolor{stringliteral}{'\%(asctime)s\ -\/\ \%(message)s'},\ filemode=\textcolor{stringliteral}{'a'})}
\DoxyCodeLine{00076\ }
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ formatted\_character:\ str\ =\ \(\backslash\)}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \ \ \ \ f\textcolor{stringliteral}{'''}}
\DoxyCodeLine{00079\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \{character\_name\_start\}}}
\DoxyCodeLine{00080\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ Description:\ \{player\_description\}}}
\DoxyCodeLine{00081\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ '''}}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ is\_new\_session\ =\ self.db.is\_new\_session\_gm\_prompt(session\_id)}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ is\_new\_session:}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ For\ new\ session,\ generate\ and\ save\ initial\ prompts}}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ fast\_flg:}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Start\ message}}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.messageGenerator.add\_system\_message(start\_message)}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ response\ =\ \textcolor{stringliteral}{"{}Understood"{}}}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.messageGenerator.add\_ai\_message(response)}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.db.save\_game\_master\_prompt(session\_id,\ \textcolor{stringliteral}{"{}start"{}},\ start\_message,\ response)}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ World\ description}}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ world\_prompt\ =\ world\_description\_start\ +\ \textcolor{stringliteral}{'\(\backslash\)n'}\ +\ self.world\_description}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.messageGenerator.add\_user\_message(world\_prompt)}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ response\ =\ \textcolor{stringliteral}{"{}Understood"{}}}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.messageGenerator.add\_system\_message(response)}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.db.save\_game\_master\_prompt(session\_id,\ \textcolor{stringliteral}{"{}world"{}},\ world\_prompt,\ response)}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Character\ description}}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.messageGenerator.add\_user\_message(formatted\_character)}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ response\ =\ \textcolor{stringliteral}{"{}Understood"{}}}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.messageGenerator.add\_system\_message(response)}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.db.save\_game\_master\_prompt(session\_id,\ \textcolor{stringliteral}{"{}character"{}},\ formatted\_character,\ response)}
\DoxyCodeLine{00106\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Start\ message}}
\DoxyCodeLine{00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ response\ =\ self.messageGenerator.generate(start\_message)}
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.db.save\_game\_master\_prompt(session\_id,\ \textcolor{stringliteral}{"{}start"{}},\ start\_message,\ response)}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ print(response)}
\DoxyCodeLine{00111\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ World\ description}}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ world\_prompt\ =\ world\_description\_start\ +\ \textcolor{stringliteral}{'\(\backslash\)n'}\ +\ self.world\_description}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ response\ =\ self.messageGenerator.generate(world\_prompt)}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.db.save\_game\_master\_prompt(session\_id,\ \textcolor{stringliteral}{"{}world"{}},\ world\_prompt,\ response)}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ print(response)}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00118\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Character\ description}}
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ response\ =\ self.messageGenerator.generate(formatted\_character)}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.db.save\_game\_master\_prompt(session\_id,\ \textcolor{stringliteral}{"{}character"{}},\ formatted\_character,\ response)}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ print(response)}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{00123\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ For\ existing\ session,\ load\ prompts\ from\ database}}
\DoxyCodeLine{00124\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ prompt\_type,\ prompt\_content,\ model\_response\ \textcolor{keywordflow}{in}\ self.db.get\_game\_master\_prompts(session\_id):}
\DoxyCodeLine{00125\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.messageGenerator.add\_system\_message(prompt\_content)}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.messageGenerator.add\_ai\_message(model\_response)}
\DoxyCodeLine{00127\ }
\DoxyCodeLine{00128\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Load\ existing\ characters\ from\ database}}
\DoxyCodeLine{00129\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ name,\ description\ \textcolor{keywordflow}{in}\ self.db.get\_characters(session\_id):}
\DoxyCodeLine{00130\ \ \ \ \ \ \ \ \ \ \ \ \ self.characters[name]\ =\ description}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Load\ master\ message\ history}}
\DoxyCodeLine{00133\ \ \ \ \ \ \ \ \ master\_history\ =\ self.db.get\_master\_messages(session\_id)}
\DoxyCodeLine{00134\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ \_,\ user\_input,\ master\_output,\ actor\_output\ \textcolor{keywordflow}{in}\ master\_history:}
\DoxyCodeLine{00135\ \ \ \ \ \ \ \ \ \ \ \ \ self.messageGenerator.add\_user\_message(user\_input)}
\DoxyCodeLine{00136\ \ \ \ \ \ \ \ \ \ \ \ \ self.messageGenerator.add\_ai\_message(master\_output)}
\DoxyCodeLine{00137\ \ \ \ \ \ \ \ \ \ \ \ \ self.messageGenerator.add\_system\_message(actor\_output)}
\DoxyCodeLine{00138\ }
\DoxyCodeLine{00139\ \ \ \ \ \textcolor{keyword}{def\ }generate\_answer(self,\ message:\ str)\ -\/>\ str:}
\DoxyCodeLine{00140\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}!}}
\DoxyCodeLine{00141\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @brief\ Генерация\ ответа\ на\ сообщение\ игрока}}
\DoxyCodeLine{00142\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{00143\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @param\ message\ Сообщение\ игрока}}
\DoxyCodeLine{00144\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{00145\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @return\ str\ Ответ\ системы}}
\DoxyCodeLine{00146\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{00147\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @throws\ PlayerDeathException\ если\ игровой\ персонаж\ умирает}}
\DoxyCodeLine{00148\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{00149\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Get\ the\ structured\ output\ from\ game\ master}}
\DoxyCodeLine{00150\ \ \ \ \ \ \ \ \ rules\ =\ \textcolor{stringliteral}{'''}}
\DoxyCodeLine{00151\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ You\ also\ need\ to\ follow\ these\ rules.}}
\DoxyCodeLine{00152\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ -\/\ You\ can't\ choose\ a\ player\ character\ in\ your\ teams.}}
\DoxyCodeLine{00153\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ -\/\ With\ any\ command\ your\ answer\ should\ always\ be\ specific.\ For\ example,\ you\ can't\ write\ that\ you\ need\ to\ come\ to\ a\ certain\ person,\ it\ has\ to\ be\ a\ specific\ person.\ You\ can't\ offer\ an\ abstract\ artifact\ sword,\ it\ has\ to\ be\ a\ specific\ sword\ with\ specific\ properties.\ If\ it\ takes\ a\ little\ more\ words,\ it's\ not\ so\ critical.}}
\DoxyCodeLine{00154\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ -\/\ If\ a\ player\ enters\ into\ a\ dialogue\ or\ performs\ an\ action,\ then\ he\ should\ get\ an\ answer,\ the\ other\ person\ should\ not\ just\ think\ or\ ignore\ it.\ Except\ in\ cases\ where\ he\ wants\ to\ ignore\ you\ for\ plot\ reasons,\ in\ which\ case\ you\ should\ indicate\ that\ he\ is\ clearly\ ignoring\ you\ intentionally\ and\ give\ a\ suggestion\ as\ to\ why\ this\ is\ happening.}}
\DoxyCodeLine{00155\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ -\/\ Never\ describe\ what\ the\ player\ is\ doing,\ always\ react\ to\ the\ player's\ actions,\ especially\ if\ he\ asked\ someone\ a\ question,\ he\ should\ answer}}
\DoxyCodeLine{00156\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ -\/\ Never\ write\ anything\ in\ the\ same\ line\ where\ you\ select\ a\ command,\ it\ will\ break\ the\ program.}}
\DoxyCodeLine{00157\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ '''}}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ commands,\ real\_game\_master\_output\ =\ self.generate\_instruction(message\ +\ \textcolor{stringliteral}{'\(\backslash\)n'}\ +\ rules)}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ game\_master\_output,\ active\_character\_names\ =\ self.parse\_commands(commands)}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00161\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Create\ active\ characters\ dictionary\ from\ the\ set\ of\ names}}
\DoxyCodeLine{00162\ \ \ \ \ \ \ \ \ active\_characters\ =\ \{name:\ self.characters[name]\ \textcolor{keywordflow}{for}\ name\ \textcolor{keywordflow}{in}\ active\_character\_names\}}
\DoxyCodeLine{00163\ \ \ \ \ \ \ \ \ self.\_\_actor.update\_active\_characters(active\_characters)}
\DoxyCodeLine{00164\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00165\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Generate\ narrative}}
\DoxyCodeLine{00166\ \ \ \ \ \ \ \ \ final\_message\ =\ self.\_\_actor.get\_detailed\_action(game\_master\_output,\ message)}
\DoxyCodeLine{00167\ \ \ \ \ \ \ \ \ actor\_message\ =\ f\textcolor{stringliteral}{"{}Actor's\ output\ (What\ the\ user\ will\ see):\(\backslash\)n\{final\_message\}"{}}}
\DoxyCodeLine{00168\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00169\ \ \ \ \ \ \ \ \ self.messageGenerator.add\_system\_message(actor\_message)}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Save\ user\ and\ master\ messages}}
\DoxyCodeLine{00172\ \ \ \ \ \ \ \ \ self.db.save\_user\_message(self.session\_id,\ message,\ final\_message)}
\DoxyCodeLine{00173\ \ \ \ \ \ \ \ \ self.db.save\_master\_message(self.session\_id,\ message,\ real\_game\_master\_output,\ actor\_message)}
\DoxyCodeLine{00174\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00175\ \ \ \ \ \ \ \ \ character\_ids\ =\ []}
\DoxyCodeLine{00176\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ name\ \textcolor{keywordflow}{in}\ active\_characters:}
\DoxyCodeLine{00177\ \ \ \ \ \ \ \ \ \ \ \ \ char\_id\ =\ self.db.get\_character\_id(self.session\_id,\ name)}
\DoxyCodeLine{00178\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ char\_id:}
\DoxyCodeLine{00179\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ character\_ids.append(char\_id)}
\DoxyCodeLine{00180\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00181\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Save\ active\ characters\ to\ DB}}
\DoxyCodeLine{00182\ \ \ \ \ \ \ \ \ image\_prompts\ =\ self.db.get\_image\_prompts(self.session\_id)}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ sequence\_number\ =\ len(image\_prompts)}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ self.db.save\_active\_characters(self.session\_id,\ sequence\_number,\ character\_ids)}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00186\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ final\_message}
\DoxyCodeLine{00187\ }
\DoxyCodeLine{00188\ \ \ \ \ \textcolor{keyword}{def\ }generate\_instruction(self,\ message:\ str)\ -\/>\ Tuple[List[CommandData],\ str]:}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}!}}
\DoxyCodeLine{00190\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @brief\ Генерация\ инструкций\ на\ основе\ сообщения}}
\DoxyCodeLine{00191\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{00192\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @param\ message\ Сообщение\ для\ обработки}}
\DoxyCodeLine{00193\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{00194\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @return\ Tuple[List[CommandData],\ str]\ Кортеж\ из\ списка\ команд\ и\ текстового\ вывода}}
\DoxyCodeLine{00195\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{00196\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @note\ Метод\ может\ выполнять\ повторные\ попытки\ генерации\ при\ некорректном\ формате}}
\DoxyCodeLine{00197\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{00198\ \ \ \ \ \ \ \ \ output:\ str\ =\ self.messageGenerator.generate(message)}
\DoxyCodeLine{00199\ \ \ \ \ \ \ \ \ parsed\_data,\ error\ =\ self.validate\_and\_parse(output)}
\DoxyCodeLine{00200\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ parsed\_data\ \textcolor{keywordflow}{is}\ \textcolor{keywordtype}{None}:}
\DoxyCodeLine{00201\ \ \ \ \ \ \ \ \ \ \ \ \ time.sleep(5)}
\DoxyCodeLine{00202\ \ \ \ \ \ \ \ \ \ \ \ \ logging.info(f\textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)nOutput:\ \{output\}\(\backslash\)nError:\ \{error\}"{}})}
\DoxyCodeLine{00203\ \ \ \ \ \ \ \ \ \ \ \ \ output\ =\ self.messageGenerator.generate(}
\DoxyCodeLine{00204\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ f\textcolor{stringliteral}{"{}Incorrect\ formatting.\ Error:\ \{error\}.\ Repeat\ using\ the\ correct.\(\backslash\)n\{correct\_formatting\}"{}})}
\DoxyCodeLine{00205\ \ \ \ \ \ \ \ \ \ \ \ \ parsed\_data,\ error\ =\ self.validate\_and\_parse(output)}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00207\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ parsed\_data,\ output}
\DoxyCodeLine{00208\ }
\DoxyCodeLine{00209\ \ \ \ \ \textcolor{keyword}{def\ }validate\_and\_parse(self,\ input\_text:\ str)\ -\/>\ Tuple[Optional[List[CommandData]],\ str]:}
\DoxyCodeLine{00210\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}!}}
\DoxyCodeLine{00211\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @brief\ Валидация\ и\ парсинг\ входного\ текста}}
\DoxyCodeLine{00212\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{00213\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @param\ input\_text\ Текст\ для\ валидации\ и\ парсинга}}
\DoxyCodeLine{00214\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{00215\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @return\ Tuple[Optional[List[CommandData]],\ str]\ Кортеж\ из\ списка\ команд\ (или\ None)\ и\ сообщения\ об\ ошибке}}
\DoxyCodeLine{00216\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{00217\ \ \ \ \ \ \ \ \ cleaned\_text\ =\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}}.join([line\ \textcolor{keywordflow}{for}\ line\ \textcolor{keywordflow}{in}\ input\_text.splitlines()\ \textcolor{keywordflow}{if}\ line.strip()])}
\DoxyCodeLine{00218\ \ \ \ \ \ \ \ \ lines\ =\ cleaned\_text.strip().split(\textcolor{stringliteral}{"{}\(\backslash\)n"{}})}
\DoxyCodeLine{00219\ \ \ \ \ \ \ \ \ i\ =\ 0}
\DoxyCodeLine{00220\ \ \ \ \ \ \ \ \ parsed\_data:\ List[CommandData]\ =\ []}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ tmp\_characters\_names:\ List[str]\ =\ []}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ i\ <\ len(lines):}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \ \ \ \ line\ =\ lines[i].strip()}
\DoxyCodeLine{00224\ }
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ line\ ==\ \textcolor{stringliteral}{"{}Create\ character\ command."{}}:}
\DoxyCodeLine{00226\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ i\ +\ 2\ >=\ len(lines):}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keywordtype}{None},\ \textcolor{stringliteral}{"{}Error:\ Incomplete\ 'Create\ a\ character\ command.'"{}}}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ name\ =\ lines[i\ +\ 1].strip()}
\DoxyCodeLine{00229\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ name\ \textcolor{keywordflow}{in}\ self.characters\ \textcolor{keywordflow}{or}\ name\ \textcolor{keywordflow}{in}\ tmp\_characters\_names:}
\DoxyCodeLine{00230\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keywordtype}{None},\ f\textcolor{stringliteral}{"{}Error:\ Character\ name\ '\{name\}'\ already\ exists."{}}}
\DoxyCodeLine{00231\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ description\ =\ lines[i\ +\ 2].strip()}
\DoxyCodeLine{00232\ }
\DoxyCodeLine{00233\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ parsed\_data.append(CommandCreateCharacter(}
\DoxyCodeLine{00234\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ name=name,}
\DoxyCodeLine{00235\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ description=description}
\DoxyCodeLine{00236\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ))}
\DoxyCodeLine{00237\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tmp\_characters\_names.append(name)}
\DoxyCodeLine{00238\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ i\ +=\ 3}
\DoxyCodeLine{00239\ }
\DoxyCodeLine{00240\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ line\ ==\ \textcolor{stringliteral}{"{}Select\ character\ command."{}}:}
\DoxyCodeLine{00241\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ i\ +\ 2\ >=\ len(lines):}
\DoxyCodeLine{00242\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keywordtype}{None},\ \textcolor{stringliteral}{"{}Error:\ Incomplete\ 'Select\ character\ command.'"{}}}
\DoxyCodeLine{00243\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ name\ =\ lines[i\ +\ 1].strip()}
\DoxyCodeLine{00244\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ name\ \textcolor{keywordflow}{not}\ \textcolor{keywordflow}{in}\ self.characters\ \textcolor{keywordflow}{and}\ name\ \textcolor{keywordflow}{not}\ \textcolor{keywordflow}{in}\ tmp\_characters\_names:}
\DoxyCodeLine{00245\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keywordtype}{None},\ f\textcolor{stringliteral}{"{}Error:\ Character\ name\ '\{name\}'\ does\ not\ exist."{}}}
\DoxyCodeLine{00246\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ action\ =\ lines[i\ +\ 2].strip()}
\DoxyCodeLine{00247\ }
\DoxyCodeLine{00248\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ parsed\_data.append(CommandSelectCharacter(}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ name=name,}
\DoxyCodeLine{00250\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ action=action}
\DoxyCodeLine{00251\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ))}
\DoxyCodeLine{00252\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ i\ +=\ 3}
\DoxyCodeLine{00253\ }
\DoxyCodeLine{00254\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ line\ ==\ \textcolor{stringliteral}{"{}Describe\ environment\ command."{}}:}
\DoxyCodeLine{00255\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ i\ +\ 1\ >=\ len(lines):}
\DoxyCodeLine{00256\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keywordtype}{None},\ \textcolor{stringliteral}{"{}Error:\ Incomplete\ 'The\ command\ to\ describe\ the\ environment.'"{}}}
\DoxyCodeLine{00257\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ description\ =\ lines[i\ +\ 1].strip()}
\DoxyCodeLine{00258\ }
\DoxyCodeLine{00259\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ parsed\_data.append(CommandDataEnvironmentDescription(}
\DoxyCodeLine{00260\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ description=description}
\DoxyCodeLine{00261\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ))}
\DoxyCodeLine{00262\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ i\ +=\ 2}
\DoxyCodeLine{00263\ }
\DoxyCodeLine{00264\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ line\ ==\ \textcolor{stringliteral}{"{}Off-\/topic\ input\ command."{}}:}
\DoxyCodeLine{00265\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ parsed\_data.append(CommandOffTopic())}
\DoxyCodeLine{00266\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ i\ +=\ 1}
\DoxyCodeLine{00267\ }
\DoxyCodeLine{00268\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ line\ ==\ \textcolor{stringliteral}{"{}Player\ death\ command."{}}:}
\DoxyCodeLine{00269\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ parsed\_data.append(CommandPlayerDeath())}
\DoxyCodeLine{00270\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ i\ +=\ 1}
\DoxyCodeLine{00271\ }
\DoxyCodeLine{00272\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{00273\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keywordtype}{None},\ f\textcolor{stringliteral}{"{}Error:\ Unrecognized\ command\ '\{line\}'"{}}}
\DoxyCodeLine{00274\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ len(parsed\_data)\ ==\ 0:}
\DoxyCodeLine{00275\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keywordtype}{None},\ f\textcolor{stringliteral}{"{}Error:\ No\ commands\ found."{}}}
\DoxyCodeLine{00276\ }
\DoxyCodeLine{00277\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ parsed\_data,\ \textcolor{stringliteral}{"{}No\ errors\ found."{}}}
\DoxyCodeLine{00278\ }
\DoxyCodeLine{00279\ \ \ \ \ \textcolor{keyword}{def\ }parse\_commands(self,\ commands:\ List[CommandData])\ -\/>\ Tuple[str,\ Set[str]]:}
\DoxyCodeLine{00280\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}!}}
\DoxyCodeLine{00281\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @brief\ Обработка\ списка\ команд}}
\DoxyCodeLine{00282\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{00283\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @param\ commands\ Список\ команд\ для\ обработки}}
\DoxyCodeLine{00284\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{00285\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @return\ Tuple[str,\ Set[str]]\ Кортеж\ из\ текстового\ вывода\ и\ множества\ имен\ активных\ персонажей}}
\DoxyCodeLine{00286\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{00287\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ @throws\ PlayerDeathException\ если\ встречена\ команда\ смерти\ игрока}}
\DoxyCodeLine{00288\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{00289\ \ \ \ \ \ \ \ \ final\_output\ =\ \textcolor{stringliteral}{"{}"{}}}
\DoxyCodeLine{00290\ \ \ \ \ \ \ \ \ active\_characters:\ Set[str]\ =\ set()}
\DoxyCodeLine{00291\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ command\ \textcolor{keywordflow}{in}\ commands:}
\DoxyCodeLine{00292\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ isinstance(command,\ CommandCreateCharacter):}
\DoxyCodeLine{00293\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.characters[command.name]\ =\ command.description}
\DoxyCodeLine{00294\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.db.save\_character(self.session\_id,\ command.name,\ command.description)}
\DoxyCodeLine{00295\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ final\_output\ +=\ f\textcolor{stringliteral}{"{}A\ new\ character\ appears:\ \{command.name\}.\ \{command.description\}\(\backslash\)n"{}}}
\DoxyCodeLine{00296\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ active\_characters.add(command.name)}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00298\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ Generate\ character\ portrait\ if\ enabled}}
\DoxyCodeLine{00299\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ self.generate\_character\_images\ \textcolor{keywordflow}{and}\ self.\_\_image\_manager:}
\DoxyCodeLine{00300\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ self.\_\_image\_manager.generate\_character\_portrait(command.name,\ command.description)}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00302\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ isinstance(command,\ CommandSelectCharacter):}
\DoxyCodeLine{00303\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ final\_output\ +=\ f\textcolor{stringliteral}{"{}\{command.name\}:\ \{command.action\}\(\backslash\)n"{}}}
\DoxyCodeLine{00304\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ active\_characters.add(command.name)}
\DoxyCodeLine{00305\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ isinstance(command,\ CommandDataEnvironmentDescription):}
\DoxyCodeLine{00306\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ final\_output\ +=\ f\textcolor{stringliteral}{"{}Environment:\ \{command.description\}\(\backslash\)n"{}}}
\DoxyCodeLine{00307\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ isinstance(command,\ CommandOffTopic):}
\DoxyCodeLine{00308\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ final\_output\ =\ \textcolor{stringliteral}{"{}Input\ is\ off-\/topic"{}}}
\DoxyCodeLine{00309\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break}}
\DoxyCodeLine{00310\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ isinstance(command,\ CommandPlayerDeath):}
\DoxyCodeLine{00311\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ final\_output\ +=\ \textcolor{stringliteral}{"{}The\ player\ character\ has\ died.\ The\ session\ has\ ended."{}}}
\DoxyCodeLine{00312\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{raise}\ PlayerDeathException(\textcolor{stringliteral}{"{}Player\ character\ has\ died.\ Session\ ended."{}})}
\DoxyCodeLine{00313\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{00314\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ final\_output,\ active\_characters}

\end{DoxyCode}
